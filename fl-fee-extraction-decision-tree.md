# 🎯 Flash Loan для Fee Extraction - Дерево решений

## 🤔 Использовать FL или нет? Простая схема

```
СТАРТ: Хочу использовать FL для Fee Extraction
                    │
                    ▼
         ┌─────────────────────┐
         │ Есть ли в пуле      │
         │ органический объем? │
         └─────────┬───────────┘
                   │
        ┌──────────┴──────────┐
        │                     │
        ▼ НЕТ                 ▼ ДА
   ❌ НЕ ИСПОЛЬЗУЙТЕ FL       │
   Будет убыток!              │
                              ▼
                   ┌─────────────────────┐
                   │ Какая ваша доля     │
                   │ в пуле/range?       │
                   └─────────┬───────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼ <50%               ▼ 50-90%            ▼ >90%
   ┌─────────────┐      ┌─────────────┐     ┌─────────────┐
   │Органика >100%│     │Органика >20%│     │Органика >5% │
   │вашего объема?│     │вашего объема?│     │вашего объема?│
   └──────┬──────┘      └──────┬──────┘     └──────┬──────┘
          │                     │                    │
      ДА  │  НЕТ           ДА  │  НЕТ          ДА  │  НЕТ
      ▼      ▼             ▼      ▼             ▼      ▼
   🤔МОЖЕТ  ❌НЕТ       ✅ДА    ❌НЕТ        🚀ДА   🤔МОЖЕТ
```

## 📊 Конкретные сценарии

### ❌ Когда FL точно НЕ стоит использовать:

```
СЦЕНАРИЙ 1: "Мертвый пул"
═══════════════════════════════════
• Вы единственный трейдер
• Органики 0%
• Любая доля

Результат: -100% потеря на FL cost
═══════════════════════════════════

СЦЕНАРИЙ 2: "Низкая доля"
═══════════════════════════════════
• Ваша доля: 20%
• Органика: 50% вашего объема
• Pool fee: 0.25%

Математика:
Потеря: 80% от fees = -0.20%
Профит: 20% от органики = +0.025%
FL cost: -0.01%
ИТОГО: -0.185% (убыток!)
═══════════════════════════════════
```

### ✅ Когда FL определенно СТОИТ использовать:

```
СЦЕНАРИЙ 1: "JIT на кита" (ЛУЧШИЙ)
═══════════════════════════════════
• Видите своп кита: $1M
• FL: $5M на 1 минуту
• Concentrated ±0.1%
• Захват: 95% fees

Профит: $2,375 - $50 FL = $2,325
ROI: 46% за минуту!
═══════════════════════════════════

СЦЕНАРИЙ 2: "High volume период"
═══════════════════════════════════
• Новый токен, первые часы
• Concentrated 95% share
• Органика: 50% вашего

Дневной профит: 10-20% на капитал
═══════════════════════════════════
```

### 🤔 Пограничные случаи:

```
СЦЕНАРИЙ: "Средняя доля + средняя органика"
═══════════════════════════════════════════
• Ваша доля: 70%
• Органика: 30% вашего
• FL cost: 0.01%

Расчет:
Потеря на wash: -0.075%
Профит от органики: +0.0525%
FL cost: -0.01%
ИТОГО: -0.0325% (маленький убыток)

Вывод: Не стоит, если только не ожидаете 
       роста органики
═══════════════════════════════════════════
```

## 🎯 Простые правила для принятия решения

### Правило 1: Минимальная органика

```
ФОРМУЛА: Органика > (100% - Ваша доля) / Ваша доля

Примеры:
• 50% доля → нужно 100% органики (1:1)
• 80% доля → нужно 25% органики
• 95% доля → нужно 5% органики
• 99% доля → нужно 1% органики
```

### Правило 2: JIT всегда выигрывает

```
Если можете делать JIT (Just-In-Time):
═══════════════════════════════════════
✅ 100% внешний объем
✅ Нет потерь на wash
✅ Максимальный ROI
✅ Используйте FL всегда!
═══════════════════════════════════════
```

### Правило 3: Concentrated обязательна

```
БЕЗ Concentrated:
• <50% доля = НЕ используйте FL
• 50-80% = Только с huge органикой
• >80% = Может работать

С Concentrated:
• 90%+ доля = FL почти всегда профитен
• 95%+ доля = FL работает с 5% органикой
• 99%+ доля = Почти гарантия профита
```

## 💰 Калькулятор быстрого решения

```python
def should_use_flash_loan(
    your_share_percent,
    expected_organic_percent,
    is_concentrated=False,
    can_do_jit=False
):
    if can_do_jit:
        return "🚀 YES! JIT всегда профитен"
    
    if expected_organic_percent == 0:
        return "❌ NO! Нет органики = убыток"
    
    if is_concentrated and your_share_percent >= 95:
        if expected_organic_percent >= 5:
            return "✅ YES! Concentrated 95%+ работает"
    
    min_organic = (100 - your_share_percent) / your_share_percent * 100
    
    if expected_organic_percent >= min_organic * 1.5:  # 50% запас
        return f"✅ YES! Органика {expected_organic_percent}% > нужных {min_organic:.1f}%"
    else:
        return f"❌ NO! Органика {expected_organic_percent}% < нужных {min_organic:.1f}%"

# Примеры использования:
print(should_use_flash_loan(50, 120))  # ✅ YES!
print(should_use_flash_loan(95, 3, is_concentrated=True))  # ❌ NO!
print(should_use_flash_loan(95, 10, is_concentrated=True))  # ✅ YES!
print(should_use_flash_loan(50, 0))  # ❌ NO!
```

## ✅ TL;DR - Супер простые правила

```
┌─────────────────────────────────────────────┐
│                                             │
│  ИСПОЛЬЗУЙТЕ FL ТОЛЬКО ЕСЛИ:                │
│                                             │
│  1. JIT на чужие большие свопы             │
│     ИЛИ                                     │
│  2. Concentrated 95%+ И органика >5%       │
│     ИЛИ                                     │
│  3. Обычная доля 80%+ И органика >25%      │
│                                             │
│  НЕ ИСПОЛЬЗУЙТЕ ЕСЛИ:                       │
│  • Нет органического объема                │
│  • Доля <50% без concentrated              │
│  • FL cost >0.02%                           │
│                                             │
│  ЗОЛОТОЕ ПРАВИЛО:                           │
│  FL для захвата ЧУЖИХ fees, не своих!      │
│                                             │
└─────────────────────────────────────────────┘
```