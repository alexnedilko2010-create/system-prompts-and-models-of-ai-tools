# 🚨 Flash Loan закроется при Self-Sandwich? 

## ❌ ГЛАВНАЯ ПРОБЛЕМА:

```
Flash Loan цикл:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. Берем FL: 300 SOL
2. Покупаем токены за 300 SOL
3. ???
4. ДОЛЖНЫ вернуть 301.5 SOL

ВОПРОС: Откуда взять SOL если всё потратили?
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 💡 Как работает Self-Sandwich с FL:

### Сценарий 1: FL покупает ВАШИ токены ✅

```
ВАШИ КОШЕЛЬКИ:          FL ПОКУПАЕТ:
┌─────────────┐         ┌─────────────┐
│ Wallet 2    │ ───50M──→ FL платит   │
│ 🪙🪙 (10%)  │ tokens   │ 45 SOL     │
├─────────────┤         ├─────────────┤
│ Wallet 3    │ ───60M──→ FL платит   │
│ 🪙🪙 (10%)  │ tokens   │ 55 SOL     │
├─────────────┤         ├─────────────┤
│ Wallet 4    │ ───40M──→ FL платит   │
│ 🪙🪙 (10%)  │ tokens   │ 40 SOL     │
└─────────────┘         └─────────────┘

ВЫ ПОЛУЧИЛИ: 140 SOL от продаж!
FL ПОТРАТИЛ: 140 SOL на ваши токены
             + 160 SOL на bonding curve
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### После миграции:

```
FL ВЛАДЕЕТ:
• 150M ваших токенов (купил дорого)
• 200M с bonding curve
• Всего: 350M токенов

FL ПРОДАЕТ 50% (175M) = получает 170 SOL

ПРОБЛЕМА:
• FL нужно вернуть: 301.5 SOL
• FL получил от продажи: 170 SOL
• НЕ ХВАТАЕТ: 131.5 SOL! ❌

FL НЕ МОЖЕТ ЗАКРЫТЬСЯ!
```

## 📊 Математика провала:

```
БЕЗ Self-Sandwich:          С Self-Sandwich:
━━━━━━━━━━━━━━━━━━━━━━    ━━━━━━━━━━━━━━━━━━━━━━

FL: 300 SOL                FL: 300 SOL
Покупает: 100% с curve     Покупает: 60% curve + 40% ваши
Получает: 400M токенов     Получает: 350M токенов

Продает: 50% = 200M        Продает: 50% = 175M  
Получает: 195 SOL          Получает: 170 SOL
                           
Не хватает: 106.5 SOL      Не хватает: 131.5 SOL
                           
Решение: Продать 60%       Решение: Продать 70%+
         = закроется                = цена обвалится!
━━━━━━━━━━━━━━━━━━━━━━    ━━━━━━━━━━━━━━━━━━━━━━
```

## ✅ РЕШЕНИЯ: Как сделать правильно

### Решение 1: Меньший FL + Ваши SOL

```
КОМБИНИРОВАННАЯ СТРАТЕГИЯ:
═══════════════════════════════════════════

Ваши ресурсы:
• 400M токенов (40% supply)
• 150 SOL наличными

План:
1. FL: 150 SOL (не 300!)
2. Ваши: 150 SOL
3. Всего: 300 SOL на покупку

Исполнение:
• Покупаете за 300 SOL → миграция
• Self-sandwich: продаете 100M за 85 SOL
• FL продает 30% позиции = 90 SOL
• 90 + 85 = 175 SOL > 150.75 нужно ✅

FL ЗАКРОЕТСЯ!
═══════════════════════════════════════════
```

### Решение 2: Правильный расчет sandwich

```
ФОРМУЛА УСПЕХА:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

FL_размер × 0.4 + Sandwich_SOL ≥ FL_долг

Пример:
• FL = 200 SOL
• FL долг = 201 SOL
• FL продаст 40% = 80 SOL
• Вам нужно из sandwich = 121 SOL минимум!

Это значит продать ~130M токенов по высокой цене
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Решение 3: Двойной FL (сложно!)

```
FL #1: Покупка позиции
FL #2: Триггер миграции + sandwich

Очень сложно технически!
Риск если первый FL изменит цену
```

## 🎯 Оптимальные параметры:

```
РАБОЧАЯ КОНФИГУРАЦИЯ:
┌─────────────────────────────────────┐
│ FL размер: 180-220 SOL (не больше!) │
│ Ваша позиция: 35-40% supply        │
│ Sandwich продажи: 25-30% позиции   │
│ Резерв SOL: 50-100 на всякий случай│
└─────────────────────────────────────┘

ПОЧЕМУ РАБОТАЕТ:
• FL меньше = меньше долг
• Больше продаете = больше SOL
• Есть запас на непредвиденное
```

## ⚠️ Критические ошибки:

```
❌ НЕ ДЕЛАЙТЕ ТАК:
• FL 300+ SOL (слишком большой долг)
• Продавать <20% в sandwich (мало SOL)
• Без резерва SOL (нет страховки)
• Жадничать с размером FL

✅ ДЕЛАЙТЕ ТАК:
• FL 150-200 SOL + ваши SOL
• Продавать 25-30% в sandwich  
• Иметь резерв 20% от FL
• Считать с запасом прочности
```

## 💡 Главный вывод:

**Self-Sandwich может СЛОМАТЬ Flash Loan если:**
- FL слишком большой
- Вы продаете слишком мало
- Нет дополнительной ликвидности

**Всегда считайте: FL продажи + Ваши sandwich SOL > FL долг!**