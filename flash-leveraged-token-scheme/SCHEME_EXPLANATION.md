# 🎯 Схема увеличения позиции через флеш-займы и собственный токен

## 📊 Визуальная схема

```
ИСХОДНОЕ СОСТОЯНИЕ:
┌─────────────────┐
│ Ваш капитал:    │
│ 3,000 USDC      │
└─────────────────┘

↓ ШАГ 1: FLASH LOAN

┌─────────────────┐    ┌─────────────────┐
│ Ваш капитал:    │ +  │ Флеш-займ:      │
│ 3,000 USDC      │    │ 10,000 USDC     │
└─────────────────┘    └─────────────────┘
                    = 13,000 USDC ВСЕГО

↓ ШАГ 2: ЗАЛОГОВОЕ КРЕДИТОВАНИЕ

┌─────────────────┐    ┌─────────────────┐
│ Залог:          │ →  │ Получено:       │
│ 8,000 USDC      │    │ 5 SOL           │
└─────────────────┘    └─────────────────┘
     (остается 5,000 USDC в резерве)

↓ ШАГ 3: ПОКУПКА КАСТОМНОГО ТОКЕНА

┌─────────────────┐    ┌─────────────────┐
│ Потрачено:      │ →  │ Получено:       │
│ 5 SOL           │    │ 5,000 CUSTOM    │
└─────────────────┘    └─────────────────┘

↓ ШАГ 4: ВОЗВРАТ FLASH LOAN

┌─────────────────┐    ┌─────────────────┐
│ Возвращено:     │    │ Комиссия:       │
│ 10,000 USDC     │ +  │ 50 USDC (0.5%)  │
└─────────────────┘    └─────────────────┘
     = 10,050 USDC ВСЕГО

↓ ИТОГОВОЕ СОСТОЯНИЕ:

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Остаток USDC:   │    │ Кастомные токены│    │ Залоговый долг: │
│ -2,050 USDC     │    │ 5,000 CUSTOM    │    │ 5 SOL           │
└─────────────────┘    └─────────────────┘    └─────────────────┘

↓ ШАГ 5: ВЫВОД ЧЕРЕЗ КАСТОМНЫЙ ТОКЕН

┌─────────────────┐    ┌─────────────────┐
│ Сжигаем:        │ →  │ Получаем:       │
│ 5,000 CUSTOM    │    │ 5 SOL           │
└─────────────────┘    └─────────────────┘
```

## 🔍 Детальный разбор схемы

### Начальное состояние
- **Ваш капитал**: 3,000 USDC
- **Цель**: Увеличить позицию в разы

### Этап 1: Flash Loan
```typescript
// Берем флеш-займ 10,000 USDC
await program.methods.flashLoan(new BN(10_000_000_000))
```
- **Получаем**: 10,000 USDC (должны вернуть в той же транзакции)
- **Всего в распоряжении**: 13,000 USDC
- **Увеличение позиции**: 4.33x от исходного капитала

### Этап 2: Залоговое кредитование
```typescript
// Размещаем 8,000 USDC под залог, получаем 5 SOL
const collateralAmount = 8_000_000_000; // 8,000 USDC
const borrowedSol = 5 * LAMPORTS_PER_SOL; // 5 SOL
```
- **Залог**: 8,000 USDC
- **Получаем**: 5 SOL (при курсе 1 SOL = 1,600 USDC)
- **LTV**: ~62.5% (безопасный уровень)

### Этап 3: Покупка кастомного токена
```typescript
// Покупаем кастомный токен на 5 SOL
await program.methods.swapSolForCustomToken(
  new BN(5 * LAMPORTS_PER_SOL),
  new BN(5000 * 1_000_000_000)
);
```
- **Тратим**: 5 SOL
- **Получаем**: 5,000 кастомных токенов
- **Курс**: 1 SOL = 1,000 кастомных токенов

### Этап 4: Возврат Flash Loan
```typescript
// Возвращаем флеш-займ с комиссией
const totalRepay = 10_000_000_000 + (10_000_000_000 * 50 / 10000);
await program.methods.repayFlashLoan();
```
- **Возвращаем**: 10,050 USDC (10,000 + 0.5% комиссия)
- **Источник**: Резерв 5,000 USDC + часть от исходного капитала

### Этап 5: Вывод позиции
```typescript
// Выводим позицию через кастомный токен
await program.methods.exitPositionViaCustomToken(
  new BN(5000 * 1_000_000_000)
);
```
- **Сжигаем**: 5,000 кастомных токенов
- **Получаем**: 5 SOL
- **Можем конвертировать**: 5 SOL → 8,000 USDC

## 📈 Финансовый результат

### Входящие активы:
- Исходный капитал: **3,000 USDC**

### Исходящие обязательства:
- Залоговый долг: **5 SOL** (≈ 8,000 USDC)
- Потрачено на комиссию флеш-займа: **50 USDC**

### Полученные активы:
- Кастомные токены: **5,000 CUSTOM** (≈ 8,000 USDC при выводе)

### Итоговая позиция:
- **Реальный капитал**: 3,000 USDC
- **Контролируемая позиция**: 8,000 USDC эквивалента
- **Коэффициент увеличения**: **2.67x**
- **Чистый долг**: 5,050 USDC

## ⚡ Ключевые преимущества

1. **Увеличение позиции**: С 3,000 до 8,000+ эквивалента
2. **Контроль через собственный токен**: Полный контроль курса и ликвидности
3. **Гибкий вывод**: Возможность вывода в любой момент
4. **Эффективность капитала**: Высокое плечо при относительно низком риске

## ⚠️ Основные риски

1. **Ликвидация**: При падении залога ниже порога
2. **Риск кастомного токена**: Потеря ликвидности или обвал курса
3. **Технические риски**: Ошибки в смарт-контрактах
4. **Регулятивные риски**: Возможные ограничения

## 🎯 Практические рекомендации

1. **Управление рисками**: Не превышать 70% LTV
2. **Диверсификация**: Не размещать весь капитал в одну схему
3. **Мониторинг**: Постоянно следить за ценами и ликвидностью
4. **Резервы**: Держать резерв для покрытия неожиданных расходов